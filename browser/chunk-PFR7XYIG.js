import{BehaviorSubject as u}from"rxjs";import*as a from"@angular/core";import*as c from"@angular/common/http";var l=class s{constructor(e){this.http=e;this.initializeUserContext()}userContextSubject=new u(null);userContext$=this.userContextSubject.asObservable();AUTH_TOKEN_KEY="auth_token";TENANT_KEY="tenant_id";async login(e,t,o){let r={username:e,password:t};o&&(r.tenant=o);let n=await this.http.post("/api/auth/login",r).toPromise();if(!n||!n.token)throw new Error("Invalid login response");localStorage.setItem(this.AUTH_TOKEN_KEY,n.token),n.tenant&&localStorage.setItem(this.TENANT_KEY,n.tenant);let i=this.parseToken(n.token);this.userContextSubject.next({userId:i.sub||i.sub||"",tenantId:i.tenant,name:i.name})}async logout(){localStorage.removeItem(this.AUTH_TOKEN_KEY),localStorage.removeItem(this.TENANT_KEY),this.userContextSubject.next(null)}async getAccessToken(){return localStorage.getItem(this.AUTH_TOKEN_KEY)}getUserContext(){return this.userContextSubject.value}isAuthenticated(){return!!localStorage.getItem(this.AUTH_TOKEN_KEY)}initializeUserContext(){let e=localStorage.getItem(this.AUTH_TOKEN_KEY);if(e)try{let t=this.parseToken(e);this.userContextSubject.next({userId:t.sub,tenantId:t.tenant,name:t.name})}catch(t){console.warn("Failed to parse token during initialization",t),localStorage.removeItem(this.AUTH_TOKEN_KEY)}}parseToken(e){try{let t=e.split(".");if(t.length<2)return{};let o=t[1],r=atob(o.replace(/-/g,"+").replace(/_/g,"/"));return JSON.parse(decodeURIComponent(escape(r)))}catch{return{}}}static \u0275fac=function(t){return new(t||s)(a.\u0275\u0275inject(c.HttpClient))};static \u0275prov=a.\u0275\u0275defineInjectable({token:s,factory:s.\u0275fac,providedIn:"root"})};export{l as a};
